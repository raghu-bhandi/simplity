<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>File Upload and Download</title>
<script type="text/javascript" src="../js/simplity.js"></script>
<!-- 
	scripts and styles specific to this page are in-lined for convenience of
	reading/understanding. Actual pages should always keep script and 
	style in separate files.
-->
<script type="text/javascript">
	var loaded = function() {
		Simplity.getResponse('tutorial.getAttachments');
		/*
		 * above call returns rootFolder and a sheet called files.
		 * we did not specify any call-back action. Simplity uses a default
		 * call-back action that pushes values from response into the document.
		 * that is how we see rootFolder and files, if any getting populated on load
		 */
	};

	var fileChanged = function() {
		var files = document.getElementById('file').files;
		var area = document.getElementById('uploadArea');
		if (!files || !files.length) {
			area.style.display = 'none';
			return;
		}
		//show this area with details
		area.style.display = '';
		var file = files[0];
		document.getElementById('fileName').innerHTML = file.name;
		document.getElementById('mimeType').innerHTML = file.mime;
		document.getElementById('fileSize').innerHTML = file.size;

		//hide progress area
		area = document.getElementById('progressArea');
		area.style.display = 'none';
	};
	/**
	 * key to the uploaded file returned by upload()
	 */
	var fileKey;
	var preloadClicked = function() {
		var files = document.getElementById('file').files;
		if (!files || !files.length) {
			Simplity.error('Choose a file name before trying an upload');
			return;
		}
		//show progress area
		var area = document.getElementById('progressArea');
		area.style.display = 'none';

		Simplity.uploadFile(files[0], function(key) {
			fileKey = key;
			var area = document.getElementById('submitArea');
			area.style.display = '';
			document.getElementById('token').innerHTML = key;
		}, function(progress) {
			Simplity.log("progress called with " + progress);
			document.getElementById('progress').innerHTML = progress;
		});
	};

	var saveClicked = function() {
		if (!fileKey) {
			Simplity.error("Please submit a file before submitting it.");
			return;
		}
		var data = '{"key":"' + fileKey + '"}';
		Simplity.getResponse('tutorial.saveAttachment', data);
	};

	var openInNew = function(key) {
		window.open('a._f?' + key);
	}
</script>
</head>
<body onload="loaded()">
		<h1>File Upload and Download Demo</h1>
		<a id="more" href="#" onclick="document.getElementById('notes').style.display = '';">Show Notes for Developer</a>
		
	<div id="notes"
		style="border: solid 1px gray; border-radius: 5px; font-style: italic; background-color: #dddddd; wdth:80%; display:none; margin:10px 10%;padding:5px 20px;">

		<p>
			Simplity provides a simple way to save attachments that form part of a transaction. for example photograph of an employee as part of employee
			master, or attachments for a service request.<br /> For security
			reasons, both upload and download are managed through a staging
			process on the web-tier. Files to be uploaded from client are first
			pre-loaded on to the web tier. They are subsequently picked up from
			server layer as part of a service execution. Similarly, a file to be
			downloaded is first copied to temp-area in the web-tier by server
			layer. It is then offered as a download to the client.
		</p>
		This demo is for a developer to understand the concepts on
		server-side and client-side. Source of this demo provides all the syntax you need to build your page and write your service. <br />
		<h3>Upload</h3>
		File(s) to be uploaded are to be first pre-loaded using url
		&quot;a._f&quot; This URL accepts a PUT method to stream the file up.
		Optional file name can be communicated with a header-field _fileName,
		and mime-type with _mimeType. This AJAX call returns a key to the
		pre-loaded file with header field _fileToken. <br />This
		functionality is provided as Simplity.uploadFile(). (refer to source file simplity.js) <br />
		Key to the pre-loaded file is then sent as input to your service.
		Service uses upload action to actually save the file from web-tier
		using the MediaStorageAssistent provided for your project. refer to
		tutorial.saveAttachment.xml service.<br />
		<h3>Download</h3>
		Down load has to be initiated by a service using download action. This
		action uses MediaStorageAssistant plug-in of your project to retrieve
		the attachment. It is then copied to the web-tier, and a key is sent
		to the client as part of response data. Refer to
		tutorial.getAttachments.xml service. <br />Actual download by client
		is straightforward once you have the key. URL a._f?key is all that you
		have to do. If you want this to be saved rather than rendered, use the
		URL a._f?download=key. <br />Refer to this html source code for
		details.
	<br />Simplity provides a folder based storage for all attachments as
	default. For the demo, we are using the following folder. This is for
	you to get some idea about the design.
	<b id="rootFolder">unknown....</b>
	<br />
	<br />If you are using Tomcat, refer to
	tomcatRoot/work/catalina/localhost/yourappName/ folder. This folder
	will have the pre-loaded and downloaded files in it. The temp folder is
	cleaned-up. Also, only your current session has access to the files
	managed in that session. If you close the browser and come back, (or
	re-login) these files, though continue to be available in this temp
	directory, are not available to be downloaded.
	<br>
	<input type="button" value="OK. Got it" onclick="this.parentNode.style.display='none';"/>
	</div>
	<form>
		<h2>STEP 1 - Select a File</h2>
		<div id="fileSelectionArea">
			<input type="file" id="file" style="display: none;"
				onchange="fileChanged(this)" /> <a href="#"><label style="cursor: pointer;"
				for="file">Click here to choose your file</label></a>
		</div>
		<h2>STEP 2 - Pre-load the file</h2>
		<p>
		<div id="uploadArea" style="display: none;">
			You have chosen file name = <span id="fileName"></span> file size = <span
				id="fileSize"></span> mime type = <span id="mimeType"></span><br />
			This file needs to be pre-loaded to server before we submit it for
			actual upload/save
			<p />
			<br /> <input type="button" value="Preload File"
				onclick="preloadClicked()" />
			<div id="progressArea" style="display: none;">
				Preloading.... <span id="progress"> %</span>
			</div>
		</div>

		<h2>STEP 3 - Submit your Transaction</h2>
		<div id="submitArea" style="display: none">
			Your pre-load is successful, and you are given a token/key of <i
				id="token"></i>. You need to use this token/key as value of a
			submitted field in your next service. In your service definition (on
			the server) you refer to this field for actual save/upload operation
			into your vault.<br /> <input type="button"
				value="Submit to Save Service" id="saveFile" onclick="saveClicked()" />
			<br /> <br />
		</div>
		<div id="downloadArea">
			<h1>Downloading Files</h1>
			<i>Note that the tokens are specific to a session, and are not
				valid across sessions</i>
			<table border="1">
				<thead>
					<tr>
						<th>File Name</th>
						<th>Mime Type</th>
						<th>token</th>
						<th>action</th>
					</tr>
				</thead>
				<tbody>
					<!-- following tr is the target for data table files. 
						We must follow the simple convention for Simplity 
						to automatically populate data.
						1. use __ as prefix and suffix to identify targets
						2. tr is our element that is to be cloned for each row.
						   we should set id="__tableName__". Also we hide it by default.
						3. wherever we want the value of a cell to be inserted, 
						   we use __columnName__. Note that a column can be used more than once
						4. Obviously, you can not have __ as normal text anywhere in the tr. Is that a real problem??
				
				 -->
					<tr id="__files__" style="display: none;">
						<td>__name__</td>
						<td>__mime__</td>
						<td>__key__</td>
						<td><a href="a._f?download=__key__">download</a></td>
						<td><a href="a._f?__key__" target="_new">open in new
								window</a></td>
					</tr>
				</tbody>
			</table>
		</div>
	</form>
</body>
</html>